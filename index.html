<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#81c784" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="favicon.ico" />
    <title>JPY/TWD æ› KRW åˆ¤æ–·å™¨ (PWA)</title>
    <style>
      :root {
        --bg: #81c784; /* æ›´æ·ºçš„ç¶ è‰²èƒŒæ™¯ */
        --card: rgba(255, 255, 255, 0.15); /* åŠé€æ˜ç™½è‰²å¡ç‰‡ */
        --muted: #2f2f2f; /* æ·±ç°è‰²æ¬¡è¦æ–‡å­— */
        --text: #2f2f2f; /* æ·±ç°è‰²ä¸»è¦æ–‡å­— */
        --accent: #1a5f1a; /* æ·±ç¶ è‰²å¼·èª¿è‰² */
        --good: #2d5a2d; /* æ·±ç¶ è‰²æˆåŠŸç‹€æ…‹ */
        --bad: #8b3a3a; /* æ·±ç´…è‰²éŒ¯èª¤ç‹€æ…‹ */
        --radius: 18px;
      }

      /* æ·±è‰²ä¸»é¡Œ - ç¶ è‰²ç³»è­·çœ¼é…è‰² */
      [data-theme="dark"] {
        --bg: #1B1F1B;
        --card: #2A322A;
        --muted: #AAB3AA;
        --text: #DDE5DD;
        --accent: #5DBB63;
        --good: #7CD992;
        --bad: #E57373;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", "Microsoft JhengHei", Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 24px;
        transition: background-color 0.3s ease, color 0.3s ease;
        font-size: 16px; /* å¢åŠ åŸºç¤å­—é«”å¤§å° */
      }

      /* æ·±è‰²ä¸»é¡ŒèƒŒæ™¯æ¼¸è®Š - ç¶ è‰²ç³»è­·çœ¼é…è‰² */
      [data-theme="dark"] body {
        background: radial-gradient(1200px 800px at 20% -10%, #222822 0%, #1B1F1B 60%, #161A16 100%);
      }

      .app {
        width: 100%;
        max-width: 840px;
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius);
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        overflow: hidden;
        backdrop-filter: blur(10px);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      /* æ·±è‰²ä¸»é¡Œå¡ç‰‡æ¨£å¼ - ç¶ è‰²ç³»è­·çœ¼é…è‰² */
      [data-theme="dark"] .app {
        background: rgba(42, 50, 42, 0.9);
        border: 1px solid #3A423A;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      header {
        padding: 20px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        gap: 12px;
        transition: border-color 0.3s ease;
      }

      [data-theme="dark"] header {
        border-bottom: 1px solid #3A423A;
      }

      header h1 {
        font-size: 24px; /* å¢åŠ æ¨™é¡Œå­—é«”å¤§å° */
        margin: 0;
        letter-spacing: 0.3px;
        color: var(--text);
        transition: color 0.3s ease;
      }
      header .badge {
        margin-left: auto;
        font-size: 14px; /* å¢åŠ å¾½ç« å­—é«”å¤§å° */
        color: var(--muted);
        transition: color 0.3s ease;
      }

      /* ä¸»é¡Œåˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
      .theme-toggle {
        margin-left: 12px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        position: relative;
      }

      .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      [data-theme="dark"] .theme-toggle {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      [data-theme="dark"] .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .theme-toggle svg {
        width: 20px;
        height: 20px;
        fill: var(--text);
        transition: all 0.3s ease;
      }

      .theme-toggle input {
        display: none;
      }

      /* Swap æ•ˆæœ */
      .swap-off {
        display: block;
      }

      .swap-on {
        display: none;
      }

      .theme-controller:checked ~ .swap-off {
        display: none;
      }

      .theme-controller:checked ~ .swap-on {
        display: block;
      }

      main {
        display: grid;
        gap: 16px;
        padding: 16px;
      }
      .grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(12, 1fr);
      }
      .card {
        grid-column: span 12;
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        padding: 14px;
        backdrop-filter: blur(5px);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      [data-theme="dark"] .card {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0));
        border: 1px solid #223;
      }

      @media (min-width: 720px) {
        .span6 {
          grid-column: span 6;
        }
        .span4 {
          grid-column: span 4;
        }
        .span12 {
          grid-column: span 12;
        }
      }
      label {
        font-size: 14px; /* å¢åŠ æ¨™ç±¤å­—é«”å¤§å° */
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
        transition: color 0.3s ease;
      }
      input {
        width: 100%;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.2);
        color: var(--text);
        outline: none;
        transition: border 0.2s, box-shadow 0.2s, background-color 0.3s ease, color 0.3s ease;
        backdrop-filter: blur(5px);
        font-size: 16px; /* å¢åŠ è¼¸å…¥æ¡†å­—é«”å¤§å° */
        -webkit-appearance: none;
        -webkit-text-fill-color: var(--text);
      }

      [data-theme="dark"] input {
        border: 1px solid #4A524A;
        background: #222822;
        -webkit-text-fill-color: var(--text);
      }

      input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(26, 95, 26, 0.25);
      }

      [data-theme="dark"] input:focus {
        box-shadow: 0 0 0 3px rgba(93, 187, 99, 0.25);
      }

      input::placeholder {
        color: rgba(47, 47, 47, 0.6);
        transition: color 0.3s ease;
      }

      [data-theme="dark"] input::placeholder {
        color: rgba(170, 179, 170, 0.8);
      }

      /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
      select {
        width: 100%;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.2);
        color: var(--text);
        outline: none;
        transition: border 0.2s, box-shadow 0.2s, background-color 0.3s ease, color 0.3s ease;
        backdrop-filter: blur(5px);
        font-size: 16px;
        cursor: pointer;
        -webkit-appearance: none;
        -webkit-text-fill-color: var(--text);
      }

      [data-theme="dark"] select {
        border: 1px solid #4A524A;
        background: #222822;
        -webkit-text-fill-color: var(--text);
      }

      select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(26, 95, 26, 0.25);
      }

      [data-theme="dark"] select:focus {
        box-shadow: 0 0 0 3px rgba(93, 187, 99, 0.25);
      }

      select option {
        background: var(--card);
        color: var(--text);
      }

      [data-theme="dark"] select option {
        background: #222822;
        color: var(--text);
      }

      .row {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
      }
      .btn {
        appearance: none;
        -webkit-appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.2);
        color: var(--text);
        padding: 12px 14px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
        font-size: 16px; /* å¢åŠ æŒ‰éˆ•å­—é«”å¤§å° */
        -webkit-text-fill-color: var(--text);
      }

      [data-theme="dark"] .btn {
        border: 1px solid #4A524A;
        background: #222822;
        -webkit-text-fill-color: var(--text);
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      [data-theme="dark"] .btn:hover {
        background: #2A322A;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .btn:active {
        transform: translateY(1px);
      }
      .primary {
        background: rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.5);
        -webkit-text-fill-color: var(--text);
      }

      [data-theme="dark"] .primary {
        background: linear-gradient(180deg, #5DBB63, #4CA85A);
        border: none;
        -webkit-text-fill-color: var(--text);
      }

      .primary:hover {
        background: rgba(255, 255, 255, 0.35);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      [data-theme="dark"] .primary:hover {
        background: linear-gradient(180deg, #6DC973, #5DBB63);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }

      .muted {
        color: var(--muted);
        font-size: 14px; /* å¢åŠ æ¬¡è¦æ–‡å­—å­—é«”å¤§å° */
        transition: color 0.3s ease;
      }
      .result {
        border-radius: 14px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px dashed rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(5px);
        transition: background-color 0.3s ease, border-color 0.3s ease;
        font-size: 16px; /* å¢åŠ çµæœå€åŸŸå­—é«”å¤§å° */
      }

      [data-theme="dark"] .result {
        background: #222822;
        border: 1px dashed #4A524A;
      }

      .pill {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 14px; /* å¢åŠ è—¥ä¸¸æ¨™ç±¤å­—é«”å¤§å° */
        border: 1px solid rgba(255, 255, 255, 0.4);
        color: var(--muted);
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      [data-theme="dark"] .pill {
        border: 1px solid #4A524A;
        background: transparent;
      }

      .good {
        color: #1a3d1a;
        background: rgba(144, 238, 144, 0.4);
        border-color: rgba(144, 238, 144, 0.6);
      }

      [data-theme="dark"] .good {
        color: #E8F5E8;
        background: rgba(124, 217, 146, 0.15);
        border-color: rgba(124, 217, 146, 0.35);
      }

      .bad {
        color: #3d1a1a;
        background: rgba(255, 182, 193, 0.4);
        border-color: rgba(255, 182, 193, 0.6);
      }

      [data-theme="dark"] .bad {
        color: #FEF2F2;
        background: rgba(229, 115, 115, 0.12);
        border-color: rgba(229, 115, 115, 0.3);
      }

      .num {
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum" 1;
      }
      footer {
        padding: 12px 16px;
        text-align: right;
        color: var(--muted);
        font-size: 14px; /* å¢åŠ é è…³å­—é«”å¤§å° */
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        transition: color 0.3s ease, border-color 0.3s ease;
      }

      [data-theme="dark"] footer {
        border-top: 1px solid #3A423A;
      }

      .hint {
        font-size: 14px; /* å¢åŠ æç¤ºæ–‡å­—å­—é«”å¤§å° */
        color: var(--muted);
        transition: color 0.3s ease;
      }

      /* æ–°å¢ï¼šJavaScript ç”¢ç”Ÿçš„ div æ¨£å¼ */
      .result-item {
        margin-bottom: 8px;
        line-height: 1.5;
      }

      .result-indent {
        margin-left: 1rem;
        margin-top: 4px;
        margin-bottom: 4px;
      }

      .result-conclusion {
        margin-top: 12px;
        font-weight: 600;
      }

      .result-amount {
        margin-top: 12px;
        font-weight: 500;
      }

      .result-bold {
        font-weight: 600;
        color: var(--accent);
      }

      /* è­¦å‘Šè¨Šæ¯æ¨£å¼ */
      .warning {
        color: var(--bad);
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.3);
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        font-weight: 500;
      }

      [data-theme="dark"] .warning {
        background: rgba(229, 115, 115, 0.15);
        border: 1px solid rgba(229, 115, 115, 0.35);
      }

      /* æ–°å¢ï¼šå³æ™‚æ›ç®—å€åŸŸæ¨£å¼ */
      .convert-section {
        margin-bottom: 16px;
      }

      .convert-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        display: block;
      }

      .convert-row {
        display: flex;
        align-items: flex-end;
        gap: 16px;
      }

      .convert-input-group {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* ä½¿ç”¨ order æ§åˆ¶é †åº */
      .convert-row .convert-arrow {
        order: 2;
        display: flex;
        align-items: center;
        height: 48px;
        font-size: 20px;
        color: var(--accent);
      }

      .convert-row .convert-swap-btn {
        order: 4;
        height: 48px;
        align-self: flex-end;
      }

      .convert-row.cvt-krw .convert-input-group.krw-group {
        order: 1;
      }

      .convert-row.cvt-krw .convert-input-group.twd-group {
        order: 3;
      }

      /* ä½¿ç”¨ order æ§åˆ¶é †åº */
      .convert-row.cvt-twd .convert-input-group.krw-group {
        order: 3;
      }

      .convert-row.cvt-twd .convert-input-group.twd-group {
        order: 1;
      }

      .convert-label {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 2px;
      }

      .convert-input {
        margin-bottom: 4px;
      }

      .convert-input[readonly] {
        background: rgba(255, 255, 255, 0.1);
        color: var(--accent);
        font-weight: 500;
        cursor: default;
        -webkit-appearance: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
        -webkit-text-fill-color: var(--accent);
        opacity: 1;
      }

      [data-theme="dark"] .convert-input[readonly] {
        background: rgba(93, 187, 99, 0.1);
        color: var(--accent);
        -webkit-text-fill-color: var(--accent);
      }

      .convert-swap-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        cursor: pointer;
        color: var(--accent);
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        margin-left: 0;
        -webkit-appearance: none;
        -webkit-text-fill-color: var(--accent);
        -webkit-user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
        outline: none;
        font-family: inherit;
        font-size: inherit;
        line-height: 1;
        padding: 0;
        box-sizing: border-box;
      }

      .convert-swap-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        -webkit-transform: scale(1.05);
      }

      .convert-swap-btn:active {
        transform: scale(0.95);
        -webkit-transform: scale(0.95);
        -webkit-tap-highlight-color: transparent;
      }

      [data-theme="dark"] .convert-swap-btn {
        border: 1px solid #4A524A;
        background: rgba(93, 187, 99, 0.1);
        -webkit-text-fill-color: var(--accent);
        -webkit-tap-highlight-color: transparent;
      }

      [data-theme="dark"] .convert-swap-btn:hover {
        background: rgba(93, 187, 99, 0.2);
        -webkit-transform: scale(1.05);
      }

      /* SVG åœ–ç¤ºæ¨£å¼ */
      .convert-swap-btn svg {
        width: 24px;
        height: 24px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
        pointer-events: none;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 600px) {
        .convert-row {
          flex-direction: column;
          gap: 12px;
        }

        .convert-swap-btn {
          align-self: center;
          margin-left: 0;
          margin-top: 8px;
        }
      }
    </style>
    
    <!-- å•Ÿå‹•æ™‚å…ˆæª¢æŸ¥ç¶²è·¯ï¼›æœ‰ç¶²è·¯æ‰æª¢æŸ¥ä¸¦å¥—ç”¨ PWA æ›´æ–°ï¼ˆService Workerï¼‰ -->
    <script>
    // è¼•é‡ç´šç·šä¸Šåµæ¸¬ï¼šå…ˆçœ‹ navigator.onLineï¼Œå†ä»¥ fetch é©—è­‰
    async function isOnline() {
      if (!navigator.onLine) return false; // å¿«é€Ÿåˆ¤å®š
      try {
        // æ‰“è‡ªå·±ç«™ä¸Šçš„å°æª”æ¡ˆï¼Œç¦ç”¨å¿«å–é¿å…é›¢ç·šå¿«å–èª¤åˆ¤
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 1500);
        const res = await fetch('./manifest.json', { cache: 'no-store', signal: ctrl.signal });
        clearTimeout(t);
        return res.ok;
      } catch (e) {
        return false;
      }
    }

    // é¡¯ç¤ºæ›´æ–°æç¤ºæ¢
    function showUpdateToast(){
      let el = document.getElementById('updateToast');
      if (!el) {
        el = document.createElement('div');
        el.id = 'updateToast';
        el.style.cssText = 'position:fixed;left:16px;right:16px;bottom:16px;background:#0e1424;color:#eaf2ff;border:1px solid #2a3552;border-radius:12px;padding:12px;display:none;z-index:9999;';
        el.innerHTML = 'æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ ğŸ‰ <button id="reloadBtn" style="margin-left:8px;padding:6px 10px;border-radius:8px;border:none;cursor:pointer;">é‡æ–°è¼‰å…¥</button>';
        document.body.appendChild(el);
      }
      el.style.display = 'block';
      document.getElementById('reloadBtn').onclick = () => location.reload();
    }

    // è¨»å†Š Service Worker ä¸¦åœ¨ã€Œæœ‰ç¶²è·¯ã€æ™‚æª¢æŸ¥æ›´æ–°
    async function ensureSWAndMaybeUpdate(){
      if (!('serviceWorker' in navigator)) return;
      try {
        const reg = await navigator.serviceWorker.register('./sw.js');

        // SW å•Ÿç”¨å¾Œï¼Œåœ¨å‡ç´šæ™‚é€šçŸ¥ UI
        navigator.serviceWorker.addEventListener('message', (evt) => {
          if (evt.data?.type === 'SW_ACTIVATED' && navigator.serviceWorker.controller) {
            showUpdateToast();
          }
        });

        // updatefound ä»£è¡¨æ‰¾åˆ°æ–° SW
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw?.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdateToast();
            }
          });
        });

        // åƒ…åœ¨ç¢ºèªç·šä¸Šæ™‚æ‰ä¸»å‹•æª¢æŸ¥æ›´æ–°
        if (await isOnline()) {
          reg.update();
        }
      } catch (e) {
        console.warn('Service worker registration failed:', e);
      }
    }

    // é¡¯ç¤ºç·šä¸Š/é›¢ç·šç‹€æ…‹å°å¾½ç« ï¼ˆå¯é¸ï¼‰
    function attachOnlineBadge(){
      let tag = document.getElementById('netBadge');
      if (!tag) {
        tag = document.createElement('div');
        tag.id = 'netBadge';
        tag.style.cssText = 'position:fixed;top:12px;right:12px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a3552;background:#0e1424;color:#9fb0ca;z-index:9999;';
        document.body.appendChild(tag);
      }
      function render(){ tag.textContent = navigator.onLine ? 'ç·šä¸Š âœ…' : 'é›¢ç·šï¼ˆå¯ç”¨å¿«å–ï¼‰'; }
      render();
      window.addEventListener('online', render);
      window.addEventListener('offline', render);
    }

    // å•Ÿå‹•é‚è¼¯ï¼šæ¯æ¬¡æ‰“é–‹é é¢å°±åŸ·è¡Œä¸€æ¬¡ç·šä¸Šæª¢æŸ¥ï¼›è‹¥ç·šä¸Šå†æª¢æŸ¥æ›´æ–°
    document.addEventListener('DOMContentLoaded', async () => {
      attachOnlineBadge();
      await ensureSWAndMaybeUpdate();
    });

    // iOS/Safari ç­‰å¾èƒŒæ™¯å›åˆ°å‰æ™¯æ™‚å†æª¢æŸ¥ä¸€æ¬¡
    window.addEventListener('pageshow', async (e) => {
      if (e.persisted) { // bfcache æ¢å¾©
        await ensureSWAndMaybeUpdate();
      }
    });
    </script>
  </head>
  <body>
    <div class="app">
      <header>
        <img src="icons/icon-192x192.png" alt="icon" width="28" height="28" style="border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3)" />
        <h1>JPY/TWD æ› KRW åˆ¤æ–·å™¨</h1>
        <span class="badge">PWA å¯å®‰è£ / é›¢ç·šå¯ç”¨</span>
        <label class="theme-toggle">
          <input type="checkbox" class="theme-controller" value="dim" />
          <svg class="swap-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"
            ></path>
          </svg>
          <svg class="swap-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"
            ></path>
          </svg>
        </label>
      </header>
      <main>
        <div class="grid">
          <!-- å³æ™‚å°å¹£æ›ç®—å€å¡Š -->
          <section class="card span12 convert-section">
            <label class="convert-title">å³æ™‚å°å¹£ï¼éŸ“å…ƒæ›ç®—</label>
            <div class="convert-row" id="convertRow">
              <div class="convert-input-group krw-group" id="krwGroup">
                <label for="convertKrw" class="convert-label">éŸ“å…ƒ (KRW)</label>
                <input id="convertKrw" type="number" step="1" placeholder="è¼¸å…¥éŸ“å…ƒé‡‘é¡" class="convert-input" />
              </div>
              <div class="convert-arrow" aria-label="ç®­é ­">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
                  <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M16 8L20 12L16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="convert-input-group twd-group" id="twdGroup">
                <label for="convertTwd" class="convert-label">å°å¹£ (TWD)</label>
                <input id="convertTwd" type="number" step="1" placeholder="çµæœ" class="convert-input" readonly />
              </div>
              <button class="convert-swap-btn" id="swapBtn" title="å°èª¿è¼¸å…¥æ¡†é †åº">
                <!-- æ”¹ç‚ºæ°´å¹³é›™å‘ç®­é ­ SVG -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <g>
                    <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15 8L19 12L15 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 16L5 12L9 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </g>
                </svg>
              </button>
            </div>
          </section>

          <section class="card span4">
            <label>å°å¹£ â†’ éŸ“å…ƒ åŒ¯ç‡ï¼ˆæ¯ 1 å°å¹£å¯æ›å¹¾éŸ“å…ƒï¼‰</label>
            <input id="twdKrw" type="number" step="0.0001" placeholder="ä¾‹å¦‚ï¼š45.2" />
            <div class="hint">ç¾å ´çœ‹æ¿ä¸Šçš„ã€ŒTWD â†’ KRWã€æ•¸å­—ã€‚</div>
          </section>
          <section class="card span4">
            <label>æ—¥å¹£ â†’ éŸ“å…ƒ åŒ¯ç‡ï¼ˆæ¯ 1 æ—¥åœ“å¯æ›å¹¾éŸ“å…ƒï¼‰</label>
            <input id="jpyKrw" type="number" step="0.0001" placeholder="ä¾‹å¦‚ï¼š9.66" />
            <div class="hint">ç¾å ´çœ‹æ¿ä¸Šçš„ã€ŒJPY â†’ KRWã€æ•¸å­—ã€‚</div>
          </section>
          <section class="card span4">
            <label>ä½ çš„æ—¥å¹£æˆæœ¬ï¼ˆå°å¹£/æ—¥åœ“ï¼‰</label>
            <input id="jpyCost" type="number" step="0.0001" placeholder="ä¾‹å¦‚ï¼š0.21" />
            <div class="hint">ä½ è²·åˆ°æ—¥å¹£ç¾éˆ”çš„æˆæœ¬ã€‚</div>
          </section>

          <section class="card span12">
            <label>ä½ æƒ³æ›çš„éŸ“å…ƒé‡‘é¡ï¼ˆKRWï¼Œå¯é¸ï¼‰</label>
            <input
              id="krwNeed"
              type="text"
              inputmode="numeric"
              step="1"
              placeholder="ä¾‹å¦‚ï¼š200,000ï¼ˆä¸å¡«å‰‡åªåˆ¤æ–·å“ªå€‹æ›´åˆ’ç®—ï¼‰"
              oninput="this.value=this.value.replace(/[^0-9]/g,'');if(this.value){this.value=Number(this.value).toLocaleString();}"
            />
          </section>

          <section class="card span12">
            <div class="row">
              <button class="btn primary" id="calcBtn">è¨ˆç®—</button>
              <button class="btn" id="resetBtn">æ¸…é™¤</button>
            </div>
          </section>

          <section class="card span12">
            <div id="summary" class="result muted"></div>
          </section>
        </div>
      </main>
      <footer>Made for quick on-the-spot exchange decisions.</footer>
    </div>

    <script>
      // ä¸»é¡Œåˆ‡æ›åŠŸèƒ½
      function initTheme() {
        const themeController = document.querySelector(".theme-controller");
        const savedTheme = localStorage.getItem("theme") || "light";

        // è¨­ç½®åˆå§‹ä¸»é¡Œ
        if (savedTheme === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
          themeController.checked = true;
        } else {
          document.documentElement.removeAttribute("data-theme");
          themeController.checked = false;
        }

        // ç›£è½ä¸»é¡Œåˆ‡æ›
        themeController.addEventListener("change", function () {
          if (this.checked) {
            document.documentElement.setAttribute("data-theme", "dark");
            localStorage.setItem("theme", "dark");
          } else {
            document.documentElement.removeAttribute("data-theme");
            localStorage.setItem("theme", "light");
          }
        });
      }

      async function registerSW() {
        if ("serviceWorker" in navigator) {
          try {
            await navigator.serviceWorker.register("./sw.js");
          } catch (e) {
            console.warn("Service worker registration failed:", e);
          }
        }
      }

      // åˆå§‹åŒ–ä¸»é¡Œå’Œ Service Worker
      initTheme();
      registerSW();

      (function () {
        const $ = (id) => document.getElementById(id);
        const fmt = (n, d = 4) =>
          Number(n).toLocaleString(undefined, {
            minimumFractionDigits: d,
            maximumFractionDigits: d,
          });
        const fmt0 = (n) => Number(n).toLocaleString(undefined);

        const baseKrw = 1000; //æ¯1000éŸ“å…ƒ

        // æœ¬åœ°å„²å­˜åŠŸèƒ½
        function saveToLocalStorage() {
          const data = {
            jpyKrw: $("jpyKrw").value,
            twdKrw: $("twdKrw").value,
            jpyCost: $("jpyCost").value,
            krwNeed: $("krwNeed").value,
            convertKrw: $("convertKrw").value,
            convertTwd: $("convertTwd").value,
          };
          localStorage.setItem("exchangeData", JSON.stringify(data));
        }

        //è¼‰å…¥æœ¬åœ°å„²å­˜è³‡æ–™
        function loadFromLocalStorage() {
          const saved = localStorage.getItem("exchangeData");
          if (saved) {
            try {
              const data = JSON.parse(saved);
              $("jpyKrw").value = data.jpyKrw || "";
              $("twdKrw").value = data.twdKrw || "";
              $("jpyCost").value = data.jpyCost || "0.21";
              $("krwNeed").value = data.krwNeed || "";
              $("convertKrw").value = data.convertKrw || "";
              $("convertTwd").value = data.convertTwd || "";
            } catch (e) {
              console.warn("è¼‰å…¥æœ¬åœ°å„²å­˜è³‡æ–™å¤±æ•—:", e);
            }
          }
        }

        // å³æ™‚æ›ç®—åŠŸèƒ½ - ä¿®å¾©é‚è¼¯
        let isUpdating = false; // é˜²æ­¢ç„¡é™å¾ªç’°

        function updateConvertResult() {
          if (isUpdating) return;

          isUpdating = true;

          const convertKrw = parseFloat($("convertKrw").value) || 0;
          const convertTwd = parseFloat($("convertTwd").value) || 0;
          const twdKrwRate = parseFloat($("twdKrw").value) || 0;

          if (convertKrw > 0 && twdKrwRate > 0) {
            // éŸ“å…ƒè½‰å°å¹£
            $("convertTwd").value = (convertKrw / twdKrwRate).toFixed(2);
          } else if (convertTwd > 0 && twdKrwRate > 0) {
            // å°å¹£è½‰éŸ“å…ƒ
            $("convertKrw").value = (convertTwd * twdKrwRate).toFixed(0);
          }

          isUpdating = false;
        }

        // éŸ“å…ƒè½‰å°å¹£
        function updateKrwToTwd() {
          if (isUpdating) return;

          isUpdating = true;

          const convertKrw = parseFloat($("convertKrw").value) || 0;
          const twdKrwRate = parseFloat($("twdKrw").value) || 0;

          if (convertKrw > 0 && twdKrwRate > 0) {
            $("convertTwd").value = (convertKrw / twdKrwRate).toFixed(2);
          }

          isUpdating = false;
        }

        // å°å¹£è½‰éŸ“å…ƒ
        function updateTwdToKrw() {
          if (isUpdating) return;

          isUpdating = true;

          const convertTwd = parseFloat($("convertTwd").value) || 0;
          const twdKrwRate = parseFloat($("twdKrw").value) || 0;

          if (convertTwd > 0 && twdKrwRate > 0) {
            $("convertKrw").value = (convertTwd * twdKrwRate).toFixed(0);
          }

          isUpdating = false;
        }

        function reset() {
          ["jpyKrw", "twdKrw", "jpyCost", "krwNeed", "convertKrw", "convertTwd"].forEach((id) => {
            document.getElementById(id).value = "";
          });
          document.getElementById("jpyCost").value = "0.21";
          document.getElementById("summary").textContent = "è«‹è¼¸å…¥åŒ¯ç‡èˆ‡ï¼ˆå¯é¸ï¼‰æƒ³æ›çš„éŸ“å…ƒé‡‘é¡ï¼Œç„¶å¾ŒæŒ‰ã€Œè¨ˆç®—ã€ã€‚";

          // æ¸…é™¤æœ¬åœ°å„²å­˜
          localStorage.removeItem("exchangeData");
        }

        function init() {
          // è¼‰å…¥æœ¬åœ°å„²å­˜è³‡æ–™
          loadFromLocalStorage();

          // è¨­ç½®åˆå§‹ç‹€æ…‹ç‚ºéŸ“å…ƒåœ¨å‰é¢
          const convertRow = document.getElementById("convertRow");
          convertRow.classList.add("cvt-krw");

          // ç¶å®šäº‹ä»¶
          document.getElementById("calcBtn").addEventListener("click", calc);
          document.getElementById("resetBtn").addEventListener("click", reset);

          // å³æ™‚æ›ç®—äº‹ä»¶ - éŸ“å…ƒè¼¸å…¥æ™‚æ›´æ–°å°å¹£
          $("convertKrw").addEventListener("input", function () {
            updateKrwToTwd();
          });

          // å°å¹£è¼¸å…¥æ™‚æ›´æ–°éŸ“å…ƒ
          $("convertTwd").addEventListener("input", function () {
            updateTwdToKrw();
          });

          // ç•¶åŒ¯ç‡æ”¹è®Šæ™‚ä¹Ÿè¦æ›´æ–°æ›ç®—çµæœ
          $("twdKrw").addEventListener("input", function () {
            const convertKrw = parseFloat($("convertKrw").value) || 0;
            const convertTwd = parseFloat($("convertTwd").value) || 0;

            if (convertKrw > 0 && !$("convertKrw").readOnly) {
              updateKrwToTwd();
            } else if (convertTwd > 0 && !$("convertTwd").readOnly) {
              updateTwdToKrw();
            }
            saveToLocalStorage();
          });

          // è‡ªå‹•å„²å­˜äº‹ä»¶
          ["jpyKrw", "jpyCost", "krwNeed"].forEach((id) => {
            document.getElementById(id).addEventListener("input", saveToLocalStorage);
            document.getElementById(id).addEventListener("change", saveToLocalStorage);
          });

          // å³æ™‚æ›ç®—çš„è¼¸å…¥æ¡†ä¹Ÿè¦å„²å­˜
          $("convertKrw").addEventListener("input", saveToLocalStorage);
          $("convertTwd").addEventListener("input", saveToLocalStorage);

          // å°èª¿æŒ‰éˆ•äº‹ä»¶
          document.getElementById("swapBtn").addEventListener("click", function () {
            const convertRow = document.getElementById("convertRow");

            // åˆ‡æ› CSS class ä¾†æ”¹è®Šé †åº
            if (convertRow.classList.contains("cvt-twd")) {
              // åˆ‡æ›å›éŸ“å…ƒåœ¨å‰é¢
              convertRow.classList.remove("cvt-twd");
              convertRow.classList.add("cvt-krw");

              // éŸ“å…ƒå¯è¼¸å…¥ï¼Œå°å¹£å”¯è®€
              $("convertKrw").removeAttribute("readonly");
              $("convertKrw").placeholder = "è¼¸å…¥éŸ“å…ƒé‡‘é¡";
              $("convertTwd").setAttribute("readonly", "");
              $("convertTwd").placeholder = "çµæœ";
            } else {
              // åˆ‡æ›åˆ°å°å¹£åœ¨å‰é¢
              convertRow.classList.remove("cvt-krw");
              convertRow.classList.add("cvt-twd");

              // å°å¹£å¯è¼¸å…¥ï¼ŒéŸ“å…ƒå”¯è®€
              $("convertTwd").removeAttribute("readonly");
              $("convertTwd").placeholder = "è¼¸å…¥å°å¹£é‡‘é¡";
              $("convertKrw").setAttribute("readonly", "");
              $("convertKrw").placeholder = "çµæœ";
            }

            // å„²å­˜åˆ°æœ¬åœ°
            saveToLocalStorage();
          });
        }
        init();

        function calc() {
          const jpyKrw = parseFloat($("jpyKrw").value); // æ—¥å¹£ â†’ éŸ“å…ƒ åŒ¯ç‡
          const twdKrw = parseFloat($("twdKrw").value); // å°å¹£ â†’ éŸ“å…ƒ åŒ¯ç‡
          const jpyCost = parseFloat($("jpyCost").value); // ä½ çš„æ—¥å¹£æˆæœ¬ï¼ˆå°å¹£/æ—¥åœ“ï¼‰
          // ä½ éœ€è¦çš„éŸ“å…ƒé‡‘é¡ï¼ˆKRWï¼‰ï¼Œä¾†æº input å¯èƒ½æœ‰åƒåˆ†ä½
          const krwNeedRaw = $("krwNeed").value.replace(/,/g, "");
          const krwNeed = parseFloat(krwNeedRaw);

          if (!(jpyKrw > 0 && twdKrw > 0 && jpyCost > 0)) {
            document.getElementById("summary").innerHTML = '<div class="warning">è«‹å…ˆå¡«å¯«ã€Œæ—¥å¹£â†’éŸ“å…ƒã€ã€ã€Œå°å¹£â†’éŸ“å…ƒã€èˆ‡ã€Œä½ çš„æ—¥å¹£æˆæœ¬ã€ã€‚</div>';
            return;
          }

          // é–€æª» JPYâ†’KRW åŒ¯ç‡
          const thresholdJPY = twdKrw * jpyCost;

          // ç”¨å°å¹£æ›éŸ“å…ƒï¼šæ¯ 1000 KRW éœ€è¦çš„ TWD æˆæœ¬
          const twdCostPerBaseKrw = baseKrw / twdKrw;

          // ç”¨æ—¥å¹£æ›éŸ“å…ƒï¼šæ¯ 1000 KRW éœ€è¦çš„ JPY æˆæœ¬
          const jpyCostPerBaseKrw = baseKrw / jpyKrw;

          // ç”¨æ—¥å¹£æ›éŸ“å…ƒï¼šæ¯ 1000 KRW éœ€è¦çš„ TWD æˆæœ¬
          const twdCostPerBaseKrwByJpy = jpyCostPerBaseKrw * jpyCost;

          // æ–°å¢ï¼šæ¯ 1 å°å¹£å¯ä»¥æ›å¤šå°‘éŸ“å…ƒ
          const krwPerTwd = twdKrw; // ç›´æ¥å°±æ˜¯å°å¹£â†’éŸ“å…ƒåŒ¯ç‡
          // æ–°å¢ï¼šç”¨æ—¥å¹£æ›éŸ“å…ƒå†æ›ç®—æˆå°å¹£ï¼Œæ¯ 1 å°å¹£å¯æ›å¤šå°‘éŸ“å…ƒ
          const krwPerTwdByJpy = jpyKrw / jpyCost;

          // åˆ¤æ–·å“ªå€‹åˆ’ç®—
          const better = jpyKrw > thresholdJPY ? "ç”¨æ—¥å¹£æ›" : "ç”¨å°å¹£æ›";
          const betterReason = `ï¼ˆç¾å ´åŒ¯ç‡ ${jpyKrw.toFixed(4)} ${jpyKrw > thresholdJPY ? "<" : ">"} é–€æª»åŒ¯ç‡ ${thresholdJPY.toFixed(4)}ï¼‰`;

          const html = [];
          html.push(`<div class="result-item">é–€æª» JPYâ†’KRW åŒ¯ç‡ï¼š<span class="result-bold">${thresholdJPY.toFixed(4)}</span> KRW</div>`);
          html.push(`<div class="result-item">ç¾å ´ JPYâ†’KRW åŒ¯ç‡ï¼š<span class="result-bold">${jpyKrw.toFixed(4)}</span> KRW</div>`);
          html.push(`<div class="result-item"><span>â¡ ç”¨å°å¹£æ›éŸ“å…ƒï¼š</span>`);
          html.push(`
<div class="result-indent">  
    <div class="result-item">æ¯ ${baseKrw} KRW æˆæœ¬ <span class="result-bold">${twdCostPerBaseKrw.toFixed(4)}</span> TWD</div>
    <div class="result-item">æ¯å°å¹£å¯æ›<span class="result-bold">${krwPerTwd.toFixed(2)}</span> éŸ“å…ƒ</div>
</div>`);

          html.push(`<div class="result-item"><span>â¡ ç”¨æ—¥å¹£æ›éŸ“å…ƒï¼š</span>`);
          html.push(`
<div class="result-indent">  
    <div class="result-item">æ¯ ${baseKrw} KRW æˆæœ¬ <span class="result-bold">${twdCostPerBaseKrwByJpy.toFixed(4)}</span> TWD (<span class="result-bold">${jpyCostPerBaseKrw.toFixed(4)}</span> JPY)</div>
    <div class="result-item">æ¯å°å¹£å¯æ›<span class="result-bold">${krwPerTwdByJpy.toFixed(2)}</span> éŸ“å…ƒï¼ˆå…ˆæ›æˆæ—¥å¹£æˆæœ¬ï¼Œå†æ›æˆå°å¹£ï¼‰</div>
</div>`);
          html.push(`<div class="result-conclusion">çµè«–ï¼š<span class="result-bold">${better}</span> æ¯”è¼ƒåˆ’ç®— ${betterReason}</div>`);

          if (krwNeed) {
            html.push(`<div class="result-amount">æ›éŸ“å…ƒï¼š<span class="result-bold">${krwNeed.toLocaleString()}</span> KRW</div>`);
            html.push(`<div class="result-item">å°å¹£ï¼š<span class="result-bold">${((krwNeed / baseKrw) * twdCostPerBaseKrw).toLocaleString()}</span> TWD</div>`);
            html.push(`<div class="result-item">æ—¥å¹£ï¼š<span class="result-bold">${((krwNeed / baseKrw) * jpyCostPerBaseKrw).toLocaleString()}</span> JPY</div>`);
            html.push(`</div>`);
          }

          document.getElementById("summary").innerHTML = html.join("");
        }
      })();
    </script>
  </body>
</html>
