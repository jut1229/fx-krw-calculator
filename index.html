<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#00d1b2" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="favicon.ico" />
    <title>JPY/TWD 換 KRW 判斷器 (PWA)</title>
    <!-- Bulma CSS Framework -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
      :root {
        --bulma-primary: #00d1b2;
        --bulma-primary-light: #ebfffc;
        --bulma-primary-dark: #00947e;
      }

      /* 深色主題支援 */
      [data-theme="dark"] {
        --bulma-primary: #00d1b2;
        --bulma-primary-light: #001a1a;
        --bulma-primary-dark: #00f5d4;
      }

      /* 自定義樣式覆蓋 */
      .hero.is-primary {
        background: linear-gradient(135deg, var(--bulma-primary) 0%, var(--bulma-primary-dark) 100%);
      }

      [data-theme="dark"] .hero.is-primary {
        background: linear-gradient(135deg, #001a1a 0%, #003333 100%);
      }

      [data-theme="dark"] body {
        background-color: #0a0a0a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .card {
        background-color: #1a1a1a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .input,
      [data-theme="dark"] .select select {
        background-color: #2a2a2a;
        border-color: #4a4a4a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .input:focus,
      [data-theme="dark"] .select select:focus {
        border-color: var(--bulma-primary);
        box-shadow: 0 0 0 0.125em rgba(0, 209, 178, 0.25);
      }

      [data-theme="dark"] .button {
        background-color: #2a2a2a;
        border-color: #4a4a4a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .button:hover {
        background-color: #3a3a3a;
        border-color: #5a5a5a;
      }

      [data-theme="dark"] .button.is-primary {
        background-color: var(--bulma-primary);
        border-color: var(--bulma-primary);
      }

      [data-theme="dark"] .button.is-primary:hover {
        background-color: var(--bulma-primary-dark);
        border-color: var(--bulma-primary-dark);
      }

      /* 主題切換按鈕 */
      .theme-toggle {
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      [data-theme="dark"] .theme-toggle {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      [data-theme="dark"] .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .theme-toggle svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
        transition: all 0.3s ease;
      }

      .theme-toggle input {
        display: none;
      }

      /* Swap 效果 */
      .swap-off {
        display: block;
      }

      .swap-on {
        display: none;
      }

      .theme-controller:checked ~ .swap-off {
        display: none;
      }

      .theme-controller:checked ~ .swap-on {
        display: block;
      }

      /* 結果樣式 */
      .result {
        border-radius: 6px;
        padding: 1rem;
        background: rgba(0, 209, 178, 0.1);
        border: 1px dashed var(--bulma-primary);
        font-size: 1rem;
      }

      [data-theme="dark"] .result {
        background: rgba(0, 209, 178, 0.05);
        border-color: var(--bulma-primary);
      }

      .pill {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        border: 1px solid #dbdbdb;
        color: #4a4a4a;
        background: #f5f5f5;
        transition: all 0.3s ease;
      }

      [data-theme="dark"] .pill {
        border: 1px solid #4a4a4a;
        background: #2a2a2a;
        color: #f5f5f5;
      }

      .good {
        color: #257942;
        background: rgba(72, 199, 116, 0.1);
        border-color: #48c774;
      }

      [data-theme="dark"] .good {
        color: #48c774;
        background: rgba(72, 199, 116, 0.1);
        border-color: #48c774;
      }

      .bad {
        color: #cc0f35;
        background: rgba(240, 71, 71, 0.1);
        border-color: #f04747;
      }

      [data-theme="dark"] .bad {
        color: #f04747;
        background: rgba(240, 71, 71, 0.1);
        border-color: #f04747;
      }

      .num {
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum" 1;
      }

      /* 結果項目樣式 */
      .result-item {
        margin-bottom: 0.5rem;
        line-height: 1.5;
      }

      .result-indent {
        margin-left: 1rem;
        margin-top: 0.25rem;
        margin-bottom: 0.25rem;
      }

      .result-conclusion {
        margin-top: 0.75rem;
        font-weight: 600;
      }

      .result-amount {
        margin-top: 0.75rem;
        font-weight: 500;
      }

      .result-bold {
        font-weight: 600;
        color: var(--bulma-primary);
      }

      /* 警告訊息樣式 */
      .warning {
        color: #cc0f35;
        background: rgba(240, 71, 71, 0.1);
        border: 1px solid #f04747;
        border-radius: 6px;
        padding: 0.75rem;
        margin: 0.5rem 0;
        font-weight: 500;
      }

      [data-theme="dark"] .warning {
        background: rgba(240, 71, 71, 0.05);
        border: 1px solid #f04747;
      }

      /* 即時換算區域樣式 */
      .convert-section {
        margin-bottom: 1rem;
      }

      .convert-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: block;
      }

      .convert-row {
        display: flex;
        align-items: flex-end;
        gap: 1rem;
      }

      .convert-input-group {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .convert-arrow {
        display: flex;
        align-items: center;
        height: 48px;
        font-size: 1.25rem;
        color: var(--bulma-primary);
      }

      /* 響應式調整 */
      @media screen and (max-width: 768px) {
        .convert-row {
          flex-direction: column;
          gap: 0.5rem;
        }
        
        .convert-arrow {
          order: 0;
          height: auto;
          justify-content: center;
          margin: 0.5rem 0;
        }
      }

      /* 深色主題額外調整 */
      [data-theme="dark"] .hero.is-primary {
        background: linear-gradient(135deg, #001a1a 0%, #003333 100%);
      }

      [data-theme="dark"] .hero.is-primary .title {
        color: #f5f5f5 !important;
      }

      [data-theme="dark"] .tag.is-light {
        background-color: #2a2a2a !important;
        color: #f5f5f5 !important;
      }

      [data-theme="dark"] .footer {
        background-color: #1a1a1a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .footer .content p {
        color: #f5f5f5;
      }

      /* 修正輸入框唯讀狀態 */
      [data-theme="dark"] .input[readonly] {
        background-color: #1a1a1a;
        color: var(--bulma-primary);
        border-color: #4a4a4a;
      }

      /* 修正按鈕樣式 */
      [data-theme="dark"] .button.is-small {
        background-color: #2a2a2a;
        border-color: #4a4a4a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .button.is-small:hover {
        background-color: #3a3a3a;
        border-color: #5a5a5a;
      }
    </style>

    <!-- 啟動時先檢查網路；有網路才檢查並套用 PWA 更新（Service Worker） -->
    <script>
      // 輕量級線上偵測：先看 navigator.onLine，再以 fetch 驗證
      async function isOnline() {
        if (!navigator.onLine) return false; // 快速判定
        try {
          // 打自己站上的小檔案，禁用快取避免離線快取誤判
          const ctrl = new AbortController();
          const t = setTimeout(() => ctrl.abort(), 1500);
          const res = await fetch("./manifest.json", { cache: "no-store", signal: ctrl.signal });
          clearTimeout(t);
          return res.ok;
        } catch (e) {
          return false;
        }
      }

      // 顯示更新提示條
      function showUpdateToast() {
        let el = document.getElementById("updateToast");
        if (!el) {
          el = document.createElement("div");
          el.id = "updateToast";
          el.style.cssText = "position:fixed;left:16px;right:16px;bottom:16px;background:#0e1424;color:#eaf2ff;border:1px solid #2a3552;border-radius:12px;padding:12px;display:none;z-index:9999;";
          el.innerHTML = '有新版本可用 🎉 <button id="reloadBtn" style="margin-left:8px;padding:6px 10px;border-radius:8px;border:none;cursor:pointer;">重新載入</button>';
          document.body.appendChild(el);
        }
        el.style.display = "block";
        document.getElementById("reloadBtn").onclick = () => location.reload();
      }

      // 註冊 Service Worker 並在「有網路」時檢查更新
      async function ensureSWAndMaybeUpdate() {
        if (!("serviceWorker" in navigator)) return;
        try {
          const reg = await navigator.serviceWorker.register("./sw.js");

          // SW 啟用後，在升級時通知 UI
          navigator.serviceWorker.addEventListener("message", (evt) => {
            if (evt.data?.type === "SW_ACTIVATED" && navigator.serviceWorker.controller) {
              showUpdateToast();
            }
          });

          // updatefound 代表找到新 SW
          reg.addEventListener("updatefound", () => {
            const nw = reg.installing;
            nw?.addEventListener("statechange", () => {
              if (nw.state === "installed" && navigator.serviceWorker.controller) {
                showUpdateToast();
              }
            });
          });

          // 僅在確認線上時才主動檢查更新
          if (await isOnline()) {
            reg.update();
          }
        } catch (e) {
          console.warn("Service worker registration failed:", e);
        }
      }

      // 顯示線上/離線狀態小徽章（可選）
      function attachOnlineBadge() {
        let tag = document.getElementById("netBadge");
        let timer = null;
        if (!tag) {
          tag = document.createElement("div");
          tag.id = "netBadge";
          tag.style.cssText = "position:fixed;top:12px;right:12px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a3552;background:#0e1424;color:#9fb0ca;z-index:9999;transition:opacity 0.3s;";
          document.body.appendChild(tag);
        }
        function showBadge() {
          tag.style.opacity = "1";
          tag.style.display = "block";
          if (timer) clearTimeout(timer);
          timer = setTimeout(() => {
            tag.style.opacity = "0";
            setTimeout(() => {
              tag.style.display = "none";
            }, 300);
          }, 5000);
        }
        function render() {
          tag.textContent = navigator.onLine ? "線上 ✅" : "離線（可用快取）";
          showBadge();
        }
        render();
        window.addEventListener("online", render);
        window.addEventListener("offline", render);
      }

      // 啟動邏輯：每次打開頁面就執行一次線上檢查；若線上再檢查更新
      document.addEventListener("DOMContentLoaded", async () => {
        attachOnlineBadge();
        await ensureSWAndMaybeUpdate();
      });

      // iOS/Safari 等從背景回到前景時再檢查一次
      window.addEventListener("pageshow", async (e) => {
        if (e.persisted) {
          // bfcache 恢復
          await ensureSWAndMaybeUpdate();
        }
      });
    </script>
  </head>
  <body>
    <section class="hero is-primary">
      <div class="hero-body">
        <div class="container">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <img src="icons/icon-192x192.png" alt="icon" width="28" height="28" style="border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3)" />
              </div>
              <div class="level-item">
                <h1 class="title has-text-white">JPY/TWD 換 KRW 判斷器</h1>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <span class="tag is-light">PWA 可安裝 / 離線可用</span>
              </div>
              <div class="level-item">
                <label class="theme-toggle">
                  <input type="checkbox" class="theme-controller" value="dim" />
                  <svg class="swap-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path
                      d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"
                    ></path>
                  </svg>
                  <svg class="swap-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path
                      d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"
                    ></path>
                  </svg>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="container">
        <div class="columns is-multiline">
          <!-- 即時台幣換算區塊 -->
          <div class="column is-12">
            <div class="card convert-section">
              <div class="card-content">
                <h3 class="title is-5 convert-title">即時台幣／韓元換算</h3>
                <div class="convert-row" id="convertRow">
                  <div class="convert-input-group krw-group" id="krwGroup">
                    <label for="convertKrw" class="label">韓元 (KRW)</label>
                    <div class="control">
                      <input id="convertKrw" type="number" step="1" placeholder="輸入韓元金額" class="input" />
                    </div>
                  </div>
                  <div class="convert-arrow" aria-label="箭頭">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle">
                      <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      <path d="M16 8L20 12L16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </div>
                  <div class="convert-input-group twd-group" id="twdGroup">
                    <label for="convertTwd" class="label">台幣 (TWD)</label>
                    <div class="control">
                      <input id="convertTwd" type="number" step="1" placeholder="結果" class="input" readonly />
                    </div>
                  </div>
                  <button class="button is-small" id="swapBtn" title="對調輸入框順序">
                    <!-- 水平雙向箭頭 SVG -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <g>
                        <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M15 8L19 12L15 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M9 16L5 12L9 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </g>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="card">
              <div class="card-content">
                <label class="label">台幣 → 韓元 匯率（每 1 台幣可換幾韓元）</label>
                <div class="control">
                  <input id="twdKrw" type="number" step="0.0001" placeholder="例如：45.2" class="input" />
                </div>
                <p class="help">現場看板上的「TWD → KRW」數字。</p>
              </div>
            </div>
          </div>
          
          <div class="column is-4">
            <div class="card">
              <div class="card-content">
                <label class="label">日幣 → 韓元 匯率（每 1 日圓可換幾韓元）</label>
                <div class="control">
                  <input id="jpyKrw" type="number" step="0.0001" placeholder="例如：9.66" class="input" />
                </div>
                <p class="help">現場看板上的「JPY → KRW」數字。</p>
              </div>
            </div>
          </div>
          
          <div class="column is-4">
            <div class="card">
              <div class="card-content">
                <label class="label">你的日幣成本（台幣/日圓）</label>
                <div class="control">
                  <input id="jpyCost" type="number" step="0.0001" placeholder="例如：0.21" class="input" />
                </div>
                <p class="help">你買到日幣現鈔的成本。</p>
              </div>
            </div>
          </div>

          <div class="column is-12">
            <div class="card">
              <div class="card-content">
                <label class="label">你想換的韓元金額（KRW，可選）</label>
                <div class="control">
                  <input
                    id="krwNeed"
                    type="text"
                    inputmode="numeric"
                    step="1"
                    placeholder="例如：200,000（不填則只判斷哪個更划算）"
                    class="input"
                    oninput="this.value=this.value.replace(/[^0-9]/g,'');if(this.value){this.value=Number(this.value).toLocaleString();}"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="column is-12">
            <div class="card">
              <div class="card-content">
                <div class="field is-grouped">
                  <div class="control">
                    <button class="button is-primary" id="calcBtn">計算</button>
                  </div>
                  <div class="control">
                    <button class="button" id="resetBtn">清除</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-12">
            <div class="card">
              <div class="card-content">
                <div id="summary" class="result"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="content has-text-centered">
        <p>Made for quick on-the-spot exchange decisions.</p>
      </div>
    </footer>

    <script>
      // 主題切換功能
      function initTheme() {
        const themeController = document.querySelector(".theme-controller");
        const savedTheme = localStorage.getItem("theme") || "light";

        // 設置初始主題
        if (savedTheme === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
          themeController.checked = true;
        } else {
          document.documentElement.removeAttribute("data-theme");
          themeController.checked = false;
        }

        // 監聽主題切換
        themeController.addEventListener("change", function () {
          if (this.checked) {
            document.documentElement.setAttribute("data-theme", "dark");
            localStorage.setItem("theme", "dark");
          } else {
            document.documentElement.removeAttribute("data-theme");
            localStorage.setItem("theme", "light");
          }
        });
      }

      async function registerSW() {
        if ("serviceWorker" in navigator) {
          try {
            await navigator.serviceWorker.register("./sw.js");
          } catch (e) {
            console.warn("Service worker registration failed:", e);
          }
        }
      }

      // 初始化主題和 Service Worker
      initTheme();
      registerSW();

      (function () {
        const $ = (id) => document.getElementById(id);
        const fmt = (n, d = 4) =>
          Number(n).toLocaleString(undefined, {
            minimumFractionDigits: d,
            maximumFractionDigits: d,
          });
        const fmt0 = (n) => Number(n).toLocaleString(undefined);

        const baseKrw = 1000; //每1000韓元

        // 本地儲存功能
        function saveToLocalStorage() {
          const data = {
            jpyKrw: $("jpyKrw").value,
            twdKrw: $("twdKrw").value,
            jpyCost: $("jpyCost").value,
            krwNeed: $("krwNeed").value,
            convertKrw: $("convertKrw").value,
            convertTwd: $("convertTwd").value,
          };
          localStorage.setItem("exchangeData", JSON.stringify(data));
        }

        //載入本地儲存資料
        function loadFromLocalStorage() {
          const saved = localStorage.getItem("exchangeData");
          if (saved) {
            try {
              const data = JSON.parse(saved);
              $("jpyKrw").value = data.jpyKrw || "";
              $("twdKrw").value = data.twdKrw || "";
              $("jpyCost").value = data.jpyCost || "0.21";
              $("krwNeed").value = data.krwNeed || "";
              $("convertKrw").value = data.convertKrw || "";
              $("convertTwd").value = data.convertTwd || "";
            } catch (e) {
              console.warn("載入本地儲存資料失敗:", e);
            }
          }
        }

        // 即時換算功能 - 修復邏輯
        let isUpdating = false; // 防止無限循環

        function updateConvertResult() {
          if (isUpdating) return;

          isUpdating = true;

          const convertKrw = parseFloat($("convertKrw").value) || 0;
          const convertTwd = parseFloat($("convertTwd").value) || 0;
          const twdKrwRate = parseFloat($("twdKrw").value) || 0;

          if (convertKrw > 0 && twdKrwRate > 0) {
            // 韓元轉台幣
            $("convertTwd").value = (convertKrw / twdKrwRate).toFixed(2);
          } else if (convertTwd > 0 && twdKrwRate > 0) {
            // 台幣轉韓元
            $("convertKrw").value = (convertTwd * twdKrwRate).toFixed(0);
          }

          isUpdating = false;
        }

        // 韓元轉台幣
        function updateKrwToTwd() {
          if (isUpdating) return;

          isUpdating = true;

          const convertKrw = parseFloat($("convertKrw").value) || 0;
          const twdKrwRate = parseFloat($("twdKrw").value) || 0;

          if (convertKrw > 0 && twdKrwRate > 0) {
            $("convertTwd").value = (convertKrw / twdKrwRate).toFixed(2);
          }

          isUpdating = false;
        }

        // 台幣轉韓元
        function updateTwdToKrw() {
          if (isUpdating) return;

          isUpdating = true;

          const convertTwd = parseFloat($("convertTwd").value) || 0;
          const twdKrwRate = parseFloat($("twdKrw").value) || 0;

          if (convertTwd > 0 && twdKrwRate > 0) {
            $("convertKrw").value = (convertTwd * twdKrwRate).toFixed(0);
          }

          isUpdating = false;
        }

        function reset() {
          ["jpyKrw", "twdKrw", "jpyCost", "krwNeed", "convertKrw", "convertTwd"].forEach((id) => {
            document.getElementById(id).value = "";
          });
          document.getElementById("jpyCost").value = "0.21";
          document.getElementById("summary").textContent = "請輸入匯率與（可選）想換的韓元金額，然後按「計算」。";

          // 清除本地儲存
          localStorage.removeItem("exchangeData");
        }

        function init() {
          // 載入本地儲存資料
          loadFromLocalStorage();

          // 設置初始狀態為韓元在前面
          const convertRow = document.getElementById("convertRow");
          convertRow.classList.add("cvt-krw");

          // 綁定事件
          document.getElementById("calcBtn").addEventListener("click", calc);
          document.getElementById("resetBtn").addEventListener("click", reset);

          // 即時換算事件 - 韓元輸入時更新台幣
          $("convertKrw").addEventListener("input", function () {
            updateKrwToTwd();
          });

          // 台幣輸入時更新韓元
          $("convertTwd").addEventListener("input", function () {
            updateTwdToKrw();
          });

          // 當匯率改變時也要更新換算結果
          $("twdKrw").addEventListener("input", function () {
            const convertKrw = parseFloat($("convertKrw").value) || 0;
            const convertTwd = parseFloat($("convertTwd").value) || 0;

            if (convertKrw > 0 && !$("convertKrw").readOnly) {
              updateKrwToTwd();
            } else if (convertTwd > 0 && !$("convertTwd").readOnly) {
              updateTwdToKrw();
            }
            saveToLocalStorage();
          });

          // 自動儲存事件
          ["jpyKrw", "jpyCost", "krwNeed"].forEach((id) => {
            document.getElementById(id).addEventListener("input", saveToLocalStorage);
            document.getElementById(id).addEventListener("change", saveToLocalStorage);
          });

          // 即時換算的輸入框也要儲存
          $("convertKrw").addEventListener("input", saveToLocalStorage);
          $("convertTwd").addEventListener("input", saveToLocalStorage);

          // 對調按鈕事件
          document.getElementById("swapBtn").addEventListener("click", function () {
            const convertRow = document.getElementById("convertRow");

            // 切換 CSS class 來改變順序
            if (convertRow.classList.contains("cvt-twd")) {
              // 切換回韓元在前面
              convertRow.classList.remove("cvt-twd");
              convertRow.classList.add("cvt-krw");

              // 韓元可輸入，台幣唯讀
              $("convertKrw").removeAttribute("readonly");
              $("convertKrw").placeholder = "輸入韓元金額";
              $("convertTwd").setAttribute("readonly", "");
              $("convertTwd").placeholder = "結果";
            } else {
              // 切換到台幣在前面
              convertRow.classList.remove("cvt-krw");
              convertRow.classList.add("cvt-twd");

              // 台幣可輸入，韓元唯讀
              $("convertTwd").removeAttribute("readonly");
              $("convertTwd").placeholder = "輸入台幣金額";
              $("convertKrw").setAttribute("readonly", "");
              $("convertKrw").placeholder = "結果";
            }

            // 儲存到本地
            saveToLocalStorage();
          });
        }
        init();

        function calc() {
          const jpyKrw = parseFloat($("jpyKrw").value); // 日幣 → 韓元 匯率
          const twdKrw = parseFloat($("twdKrw").value); // 台幣 → 韓元 匯率
          const jpyCost = parseFloat($("jpyCost").value); // 你的日幣成本（台幣/日圓）
          // 你需要的韓元金額（KRW），來源 input 可能有千分位
          const krwNeedRaw = $("krwNeed").value.replace(/,/g, "");
          const krwNeed = parseFloat(krwNeedRaw);

          if (!(jpyKrw > 0 && twdKrw > 0 && jpyCost > 0)) {
            document.getElementById("summary").innerHTML = '<div class="warning">請先填寫「日幣→韓元」、「台幣→韓元」與「你的日幣成本」。</div>';
            return;
          }

          // 門檻 JPY→KRW 匯率
          const thresholdJPY = twdKrw * jpyCost;

          // 用台幣換韓元：每 1000 KRW 需要的 TWD 成本
          const twdCostPerBaseKrw = baseKrw / twdKrw;

          // 用日幣換韓元：每 1000 KRW 需要的 JPY 成本
          const jpyCostPerBaseKrw = baseKrw / jpyKrw;

          // 用日幣換韓元：每 1000 KRW 需要的 TWD 成本
          const twdCostPerBaseKrwByJpy = jpyCostPerBaseKrw * jpyCost;

          // 新增：每 1 台幣可以換多少韓元
          const krwPerTwd = twdKrw; // 直接就是台幣→韓元匯率
          // 新增：用日幣換韓元再換算成台幣，每 1 台幣可換多少韓元
          const krwPerTwdByJpy = jpyKrw / jpyCost;

          // 判斷哪個划算
          const better = jpyKrw > thresholdJPY ? "用日幣換" : "用台幣換";
          const betterReason = `（現場匯率 ${jpyKrw.toFixed(4)} ${jpyKrw > thresholdJPY ? "<" : ">"} 門檻匯率 ${thresholdJPY.toFixed(4)}）`;

          const html = [];
          html.push(`<div class="result-item">門檻 JPY→KRW 匯率：<span class="result-bold">${thresholdJPY.toFixed(4)}</span> KRW</div>`);
          html.push(`<div class="result-item">現場 JPY→KRW 匯率：<span class="result-bold">${jpyKrw.toFixed(4)}</span> KRW</div>`);
          html.push(`<div class="result-item"><span>➡ 用台幣換韓元：</span>`);
          html.push(`
<div class="result-indent">  
    <div class="result-item">每 ${baseKrw} KRW 成本 <span class="result-bold">${twdCostPerBaseKrw.toFixed(4)}</span> TWD</div>
    <div class="result-item">每台幣可換<span class="result-bold">${krwPerTwd.toFixed(2)}</span> 韓元</div>
</div>`);

          html.push(`<div class="result-item"><span>➡ 用日幣換韓元：</span>`);
          html.push(`
<div class="result-indent">  
    <div class="result-item">每 ${baseKrw} KRW 成本 <span class="result-bold">${twdCostPerBaseKrwByJpy.toFixed(4)}</span> TWD (<span class="result-bold">${jpyCostPerBaseKrw.toFixed(4)}</span> JPY)</div>
    <div class="result-item">每台幣可換<span class="result-bold">${krwPerTwdByJpy.toFixed(2)}</span> 韓元（先換成日幣成本，再換成台幣）</div>
</div>`);
          html.push(`<div class="result-conclusion">結論：<span class="result-bold">${better}</span> 比較划算 ${betterReason}</div>`);

          if (krwNeed) {
            html.push(`<div class="result-amount">換韓元：<span class="result-bold">${krwNeed.toLocaleString()}</span> KRW</div>`);
            html.push(`<div class="result-item">台幣：<span class="result-bold">${((krwNeed / baseKrw) * twdCostPerBaseKrw).toLocaleString()}</span> TWD</div>`);
            html.push(`<div class="result-item">日幣：<span class="result-bold">${((krwNeed / baseKrw) * jpyCostPerBaseKrw).toLocaleString()}</span> JPY</div>`);
            html.push(`</div>`);
          }

          document.getElementById("summary").innerHTML = html.join("");
        }
      })();
    </script>
  </body>
</html>
