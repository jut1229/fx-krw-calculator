<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#00d1b2" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="favicon.ico" />
    <title>JPY/TWD æ› KRW åˆ¤æ–·å™¨ (PWA)</title>
    <!-- Bulma CSS Framework -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
      :root {
        --bulma-primary: #00d1b2;
        --bulma-primary-light: #ebfffc;
        --bulma-primary-dark: #00947e;
      }

      /* æ·±è‰²ä¸»é¡Œæ”¯æ´ */
      [data-theme="dark"] {
        --bulma-primary: #00d1b2;
        --bulma-primary-light: #001a1a;
        --bulma-primary-dark: #00f5d4;
      }

      /* è‡ªå®šç¾©æ¨£å¼è¦†è“‹ */
      .hero.is-primary {
        background: linear-gradient(135deg, var(--bulma-primary) 0%, var(--bulma-primary-dark) 100%);
      }

      [data-theme="dark"] .hero.is-primary {
        background: linear-gradient(135deg, #001a1a 0%, #003333 100%);
      }

      [data-theme="dark"] body {
        background-color: #0a0a0a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .card {
        background-color: #1a1a1a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .input,
      [data-theme="dark"] .select select {
        background-color: #2a2a2a;
        border-color: #4a4a4a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .input:focus,
      [data-theme="dark"] .select select:focus {
        border-color: var(--bulma-primary);
        box-shadow: 0 0 0 0.125em rgba(0, 209, 178, 0.25);
      }

      [data-theme="dark"] .button {
        background-color: #2a2a2a;
        border-color: #4a4a4a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .button:hover {
        background-color: #3a3a3a;
        border-color: #5a5a5a;
      }

      [data-theme="dark"] .button.is-primary {
        background-color: var(--bulma-primary);
        border-color: var(--bulma-primary);
      }

      [data-theme="dark"] .button.is-primary:hover {
        background-color: var(--bulma-primary-dark);
        border-color: var(--bulma-primary-dark);
      }

      /* ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• */
      .theme-toggle {
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      [data-theme="dark"] .theme-toggle {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      [data-theme="dark"] .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .theme-toggle svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
        transition: all 0.3s ease;
      }

      .theme-toggle input {
        display: none;
      }

      /* Swap æ•ˆæœ */
      .swap-off {
        display: block;
      }

      .swap-on {
        display: none;
      }

      .theme-controller:checked ~ .swap-off {
        display: none;
      }

      .theme-controller:checked ~ .swap-on {
        display: block;
      }

      /* çµæœæ¨£å¼ */
      .result {
        border-radius: 6px;
        padding: 1rem;
        background: rgba(0, 209, 178, 0.1);
        border: 1px dashed var(--bulma-primary);
        font-size: 1rem;
      }

      [data-theme="dark"] .result {
        background: rgba(0, 209, 178, 0.05);
        border-color: var(--bulma-primary);
      }

      .pill {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        border: 1px solid #dbdbdb;
        color: #4a4a4a;
        background: #f5f5f5;
        transition: all 0.3s ease;
      }

      [data-theme="dark"] .pill {
        border: 1px solid #4a4a4a;
        background: #2a2a2a;
        color: #f5f5f5;
      }

      .good {
        color: #257942;
        background: rgba(72, 199, 116, 0.1);
        border-color: #48c774;
      }

      [data-theme="dark"] .good {
        color: #48c774;
        background: rgba(72, 199, 116, 0.1);
        border-color: #48c774;
      }

      .bad {
        color: #cc0f35;
        background: rgba(240, 71, 71, 0.1);
        border-color: #f04747;
      }

      [data-theme="dark"] .bad {
        color: #f04747;
        background: rgba(240, 71, 71, 0.1);
        border-color: #f04747;
      }

      .num {
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum" 1;
      }

      /* çµæœé …ç›®æ¨£å¼ */
      .result-item {
        margin-bottom: 0.5rem;
        line-height: 1.5;
      }

      .result-indent {
        margin-left: 1rem;
        margin-top: 0.25rem;
        margin-bottom: 0.25rem;
      }

      .result-conclusion {
        margin-top: 0.75rem;
        font-weight: 600;
      }

      .result-amount {
        margin-top: 0.75rem;
        font-weight: 500;
      }

      .result-bold {
        font-weight: 600;
        color: var(--bulma-primary);
      }

      /* è­¦å‘Šè¨Šæ¯æ¨£å¼ */
      .warning {
        color: #cc0f35;
        background: rgba(240, 71, 71, 0.1);
        border: 1px solid #f04747;
        border-radius: 6px;
        padding: 0.75rem;
        margin: 0.5rem 0;
        font-weight: 500;
      }

      [data-theme="dark"] .warning {
        background: rgba(240, 71, 71, 0.05);
        border: 1px solid #f04747;
      }

      /* å³æ™‚æ›ç®—å€åŸŸæ¨£å¼ */
      .convert-section {
        margin-bottom: 1rem;
      }

      .convert-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: block;
      }

      .convert-row {
        display: flex;
        align-items: flex-end;
        gap: 1rem;
      }

      .convert-input-group {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .convert-arrow {
        display: flex;
        align-items: center;
        height: 48px;
        font-size: 1.25rem;
        color: var(--bulma-primary);
      }

      /* éŸ¿æ‡‰å¼èª¿æ•´ */
      @media screen and (max-width: 768px) {
        .convert-row {
          flex-direction: column;
          gap: 0.5rem;
        }
        
        .convert-arrow {
          order: 0;
          height: auto;
          justify-content: center;
          margin: 0.5rem 0;
        }
      }

      /* æ·±è‰²ä¸»é¡Œé¡å¤–èª¿æ•´ */
      [data-theme="dark"] .hero.is-primary {
        background: linear-gradient(135deg, #001a1a 0%, #003333 100%);
      }

      [data-theme="dark"] .hero.is-primary .title {
        color: #f5f5f5 !important;
      }

      [data-theme="dark"] .tag.is-light {
        background-color: #2a2a2a !important;
        color: #f5f5f5 !important;
      }

      [data-theme="dark"] .footer {
        background-color: #1a1a1a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .footer .content p {
        color: #f5f5f5;
      }

      /* ä¿®æ­£è¼¸å…¥æ¡†å”¯è®€ç‹€æ…‹ */
      [data-theme="dark"] .input[readonly] {
        background-color: #1a1a1a;
        color: var(--bulma-primary);
        border-color: #4a4a4a;
      }

      /* ä¿®æ­£æŒ‰éˆ•æ¨£å¼ */
      [data-theme="dark"] .button.is-small {
        background-color: #2a2a2a;
        border-color: #4a4a4a;
        color: #f5f5f5;
      }

      [data-theme="dark"] .button.is-small:hover {
        background-color: #3a3a3a;
        border-color: #5a5a5a;
      }
    </style>

    <!-- å•Ÿå‹•æ™‚å…ˆæª¢æŸ¥ç¶²è·¯ï¼›æœ‰ç¶²è·¯æ‰æª¢æŸ¥ä¸¦å¥—ç”¨ PWA æ›´æ–°ï¼ˆService Workerï¼‰ -->
    <script>
      // è¼•é‡ç´šç·šä¸Šåµæ¸¬ï¼šå…ˆçœ‹ navigator.onLineï¼Œå†ä»¥ fetch é©—è­‰
      async function isOnline() {
        if (!navigator.onLine) return false; // å¿«é€Ÿåˆ¤å®š
        try {
          // æ‰“è‡ªå·±ç«™ä¸Šçš„å°æª”æ¡ˆï¼Œç¦ç”¨å¿«å–é¿å…é›¢ç·šå¿«å–èª¤åˆ¤
          const ctrl = new AbortController();
          const t = setTimeout(() => ctrl.abort(), 1500);
          const res = await fetch("./manifest.json", { cache: "no-store", signal: ctrl.signal });
          clearTimeout(t);
          return res.ok;
        } catch (e) {
          return false;
        }
      }

      // é¡¯ç¤ºæ›´æ–°æç¤ºæ¢
      function showUpdateToast() {
        let el = document.getElementById("updateToast");
        if (!el) {
          el = document.createElement("div");
          el.id = "updateToast";
          el.style.cssText = "position:fixed;left:16px;right:16px;bottom:16px;background:#0e1424;color:#eaf2ff;border:1px solid #2a3552;border-radius:12px;padding:12px;display:none;z-index:9999;";
          el.innerHTML = 'æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ ğŸ‰ <button id="reloadBtn" style="margin-left:8px;padding:6px 10px;border-radius:8px;border:none;cursor:pointer;">é‡æ–°è¼‰å…¥</button>';
          document.body.appendChild(el);
        }
        el.style.display = "block";
        document.getElementById("reloadBtn").onclick = () => location.reload();
      }

      // è¨»å†Š Service Worker ä¸¦åœ¨ã€Œæœ‰ç¶²è·¯ã€æ™‚æª¢æŸ¥æ›´æ–°
      async function ensureSWAndMaybeUpdate() {
        if (!("serviceWorker" in navigator)) return;
        try {
          const reg = await navigator.serviceWorker.register("./sw.js");

          // SW å•Ÿç”¨å¾Œï¼Œåœ¨å‡ç´šæ™‚é€šçŸ¥ UI
          navigator.serviceWorker.addEventListener("message", (evt) => {
            if (evt.data?.type === "SW_ACTIVATED" && navigator.serviceWorker.controller) {
              showUpdateToast();
            }
          });

          // updatefound ä»£è¡¨æ‰¾åˆ°æ–° SW
          reg.addEventListener("updatefound", () => {
            const nw = reg.installing;
            nw?.addEventListener("statechange", () => {
              if (nw.state === "installed" && navigator.serviceWorker.controller) {
                showUpdateToast();
              }
            });
          });

          // åƒ…åœ¨ç¢ºèªç·šä¸Šæ™‚æ‰ä¸»å‹•æª¢æŸ¥æ›´æ–°
          if (await isOnline()) {
            reg.update();
          }
        } catch (e) {
          console.warn("Service worker registration failed:", e);
        }
      }

      // é¡¯ç¤ºç·šä¸Š/é›¢ç·šç‹€æ…‹å°å¾½ç« ï¼ˆå¯é¸ï¼‰
      function attachOnlineBadge() {
        let tag = document.getElementById("netBadge");
        let timer = null;
        if (!tag) {
          tag = document.createElement("div");
          tag.id = "netBadge";
          tag.style.cssText = "position:fixed;top:12px;right:12px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a3552;background:#0e1424;color:#9fb0ca;z-index:9999;transition:opacity 0.3s;";
          document.body.appendChild(tag);
        }
        function showBadge() {
          tag.style.opacity = "1";
          tag.style.display = "block";
          if (timer) clearTimeout(timer);
          timer = setTimeout(() => {
            tag.style.opacity = "0";
            setTimeout(() => {
              tag.style.display = "none";
            }, 300);
          }, 5000);
        }
        function render() {
          tag.textContent = navigator.onLine ? "ç·šä¸Š âœ…" : "é›¢ç·šï¼ˆå¯ç”¨å¿«å–ï¼‰";
          showBadge();
        }
        render();
        window.addEventListener("online", render);
        window.addEventListener("offline", render);
      }

      // å•Ÿå‹•é‚è¼¯ï¼šæ¯æ¬¡æ‰“é–‹é é¢å°±åŸ·è¡Œä¸€æ¬¡ç·šä¸Šæª¢æŸ¥ï¼›è‹¥ç·šä¸Šå†æª¢æŸ¥æ›´æ–°
      document.addEventListener("DOMContentLoaded", async () => {
        attachOnlineBadge();
        await ensureSWAndMaybeUpdate();
      });

      // iOS/Safari ç­‰å¾èƒŒæ™¯å›åˆ°å‰æ™¯æ™‚å†æª¢æŸ¥ä¸€æ¬¡
      window.addEventListener("pageshow", async (e) => {
        if (e.persisted) {
          // bfcache æ¢å¾©
          await ensureSWAndMaybeUpdate();
        }
      });
    </script>
  </head>
  <body>
    <section class="hero is-primary">
      <div class="hero-body">
        <div class="container">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <img src="icons/icon-192x192.png" alt="icon" width="28" height="28" style="border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3)" />
              </div>
              <div class="level-item">
                <h1 class="title has-text-white">JPY/TWD æ› KRW åˆ¤æ–·å™¨</h1>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <span class="tag is-light">PWA å¯å®‰è£ / é›¢ç·šå¯ç”¨</span>
              </div>
              <div class="level-item">
                <label class="theme-toggle">
                  <input type="checkbox" class="theme-controller" value="dim" />
                  <svg class="swap-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path
                      d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"
                    ></path>
                  </svg>
                  <svg class="swap-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path
                      d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"
                    ></path>
                  </svg>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="container">
        <div class="columns is-multiline">
          <!-- å³æ™‚å°å¹£æ›ç®—å€å¡Š -->
          <div class="column is-12">
            <div class="card convert-section">
              <div class="card-content">
                <h3 class="title is-5 convert-title">å³æ™‚å°å¹£ï¼éŸ“å…ƒæ›ç®—</h3>
                <div class="convert-row" id="convertRow">
                  <div class="convert-input-group krw-group" id="krwGroup">
                    <label for="convertKrw" class="label">éŸ“å…ƒ (KRW)</label>
                    <div class="control">
                      <input id="convertKrw" type="number" step="1" placeholder="è¼¸å…¥éŸ“å…ƒé‡‘é¡" class="input" />
                    </div>
                  </div>
                  <div class="convert-arrow" aria-label="ç®­é ­">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle">
                      <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      <path d="M16 8L20 12L16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </div>
                  <div class="convert-input-group twd-group" id="twdGroup">
                    <label for="convertTwd" class="label">å°å¹£ (TWD)</label>
                    <div class="control">
                      <input id="convertTwd" type="number" step="1" placeholder="çµæœ" class="input" readonly />
                    </div>
                  </div>
                  <button class="button is-small" id="swapBtn" title="å°èª¿è¼¸å…¥æ¡†é †åº">
                    <!-- æ°´å¹³é›™å‘ç®­é ­ SVG -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <g>
                        <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M15 8L19 12L15 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M9 16L5 12L9 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </g>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="card">
              <div class="card-content">
                <label class="label">å°å¹£ â†’ éŸ“å…ƒ åŒ¯ç‡ï¼ˆæ¯ 1 å°å¹£å¯æ›å¹¾éŸ“å…ƒï¼‰</label>
                <div class="control">
                  <input id="twdKrw" type="number" step="0.0001" placeholder="ä¾‹å¦‚ï¼š45.2" class="input" />
                </div>
                <p class="help">ç¾å ´çœ‹æ¿ä¸Šçš„ã€ŒTWD â†’ KRWã€æ•¸å­—ã€‚</p>
              </div>
            </div>
          </div>
          
          <div class="column is-4">
            <div class="card">
              <div class="card-content">
                <label class="label">æ—¥å¹£ â†’ éŸ“å…ƒ åŒ¯ç‡ï¼ˆæ¯ 1 æ—¥åœ“å¯æ›å¹¾éŸ“å…ƒï¼‰</label>
                <div class="control">
                  <input id="jpyKrw" type="number" step="0.0001" placeholder="ä¾‹å¦‚ï¼š9.66" class="input" />
                </div>
                <p class="help">ç¾å ´çœ‹æ¿ä¸Šçš„ã€ŒJPY â†’ KRWã€æ•¸å­—ã€‚</p>
              </div>
            </div>
          </div>
          
          <div class="column is-4">
            <div class="card">
              <div class="card-content">
                <label class="label">ä½ çš„æ—¥å¹£æˆæœ¬ï¼ˆå°å¹£/æ—¥åœ“ï¼‰</label>
                <div class="control">
                  <input id="jpyCost" type="number" step="0.0001" placeholder="ä¾‹å¦‚ï¼š0.21" class="input" />
                </div>
                <p class="help">ä½ è²·åˆ°æ—¥å¹£ç¾éˆ”çš„æˆæœ¬ã€‚</p>
              </div>
            </div>
          </div>

          <div class="column is-12">
            <div class="card">
              <div class="card-content">
                <label class="label">ä½ æƒ³æ›çš„éŸ“å…ƒé‡‘é¡ï¼ˆKRWï¼Œå¯é¸ï¼‰</label>
                <div class="control">
                  <input
                    id="krwNeed"
                    type="text"
                    inputmode="numeric"
                    step="1"
                    placeholder="ä¾‹å¦‚ï¼š200,000ï¼ˆä¸å¡«å‰‡åªåˆ¤æ–·å“ªå€‹æ›´åˆ’ç®—ï¼‰"
                    class="input"
                    oninput="this.value=this.value.replace(/[^0-9]/g,'');if(this.value){this.value=Number(this.value).toLocaleString();}"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="column is-12">
            <div class="card">
              <div class="card-content">
                <div class="field is-grouped">
                  <div class="control">
                    <button class="button is-primary" id="calcBtn">è¨ˆç®—</button>
                  </div>
                  <div class="control">
                    <button class="button" id="resetBtn">æ¸…é™¤</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-12">
            <div class="card">
              <div class="card-content">
                <div id="summary" class="result"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="content has-text-centered">
        <p>Made for quick on-the-spot exchange decisions.</p>
      </div>
    </footer>

    <script>
      // ä¸»é¡Œåˆ‡æ›åŠŸèƒ½
      function initTheme() {
        const themeController = document.querySelector(".theme-controller");
        const savedTheme = localStorage.getItem("theme") || "light";

        // è¨­ç½®åˆå§‹ä¸»é¡Œ
        if (savedTheme === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
          themeController.checked = true;
        } else {
          document.documentElement.removeAttribute("data-theme");
          themeController.checked = false;
        }

        // ç›£è½ä¸»é¡Œåˆ‡æ›
        themeController.addEventListener("change", function () {
          if (this.checked) {
            document.documentElement.setAttribute("data-theme", "dark");
            localStorage.setItem("theme", "dark");
          } else {
            document.documentElement.removeAttribute("data-theme");
            localStorage.setItem("theme", "light");
          }
        });
      }

      async function registerSW() {
        if ("serviceWorker" in navigator) {
          try {
            await navigator.serviceWorker.register("./sw.js");
          } catch (e) {
            console.warn("Service worker registration failed:", e);
          }
        }
      }

      // åˆå§‹åŒ–ä¸»é¡Œå’Œ Service Worker
      initTheme();
      registerSW();

      (function () {
        const $ = (id) => document.getElementById(id);
        const fmt = (n, d = 4) =>
          Number(n).toLocaleString(undefined, {
            minimumFractionDigits: d,
            maximumFractionDigits: d,
          });
        const fmt0 = (n) => Number(n).toLocaleString(undefined);

        const baseKrw = 1000; //æ¯1000éŸ“å…ƒ

        // æœ¬åœ°å„²å­˜åŠŸèƒ½
        function saveToLocalStorage() {
          const data = {
            jpyKrw: $("jpyKrw").value,
            twdKrw: $("twdKrw").value,
            jpyCost: $("jpyCost").value,
            krwNeed: $("krwNeed").value,
            convertKrw: $("convertKrw").value,
            convertTwd: $("convertTwd").value,
          };
          localStorage.setItem("exchangeData", JSON.stringify(data));
        }

        //è¼‰å…¥æœ¬åœ°å„²å­˜è³‡æ–™
        function loadFromLocalStorage() {
          const saved = localStorage.getItem("exchangeData");
          if (saved) {
            try {
              const data = JSON.parse(saved);
              $("jpyKrw").value = data.jpyKrw || "";
              $("twdKrw").value = data.twdKrw || "";
              $("jpyCost").value = data.jpyCost || "0.21";
              $("krwNeed").value = data.krwNeed || "";
              $("convertKrw").value = data.convertKrw || "";
              $("convertTwd").value = data.convertTwd || "";
            } catch (e) {
              console.warn("è¼‰å…¥æœ¬åœ°å„²å­˜è³‡æ–™å¤±æ•—:", e);
            }
          }
        }

        // å³æ™‚æ›ç®—åŠŸèƒ½ - ä¿®å¾©é‚è¼¯
        let isUpdating = false; // é˜²æ­¢ç„¡é™å¾ªç’°

        function updateConvertResult() {
          if (isUpdating) return;

          isUpdating = true;

          const convertKrw = parseFloat($("convertKrw").value) || 0;
          const convertTwd = parseFloat($("convertTwd").value) || 0;
          const twdKrwRate = parseFloat($("twdKrw").value) || 0;

          if (convertKrw > 0 && twdKrwRate > 0) {
            // éŸ“å…ƒè½‰å°å¹£
            $("convertTwd").value = (convertKrw / twdKrwRate).toFixed(2);
          } else if (convertTwd > 0 && twdKrwRate > 0) {
            // å°å¹£è½‰éŸ“å…ƒ
            $("convertKrw").value = (convertTwd * twdKrwRate).toFixed(0);
          }

          isUpdating = false;
        }

        // éŸ“å…ƒè½‰å°å¹£
        function updateKrwToTwd() {
          if (isUpdating) return;

          isUpdating = true;

          const convertKrw = parseFloat($("convertKrw").value) || 0;
          const twdKrwRate = parseFloat($("twdKrw").value) || 0;

          if (convertKrw > 0 && twdKrwRate > 0) {
            $("convertTwd").value = (convertKrw / twdKrwRate).toFixed(2);
          }

          isUpdating = false;
        }

        // å°å¹£è½‰éŸ“å…ƒ
        function updateTwdToKrw() {
          if (isUpdating) return;

          isUpdating = true;

          const convertTwd = parseFloat($("convertTwd").value) || 0;
          const twdKrwRate = parseFloat($("twdKrw").value) || 0;

          if (convertTwd > 0 && twdKrwRate > 0) {
            $("convertKrw").value = (convertTwd * twdKrwRate).toFixed(0);
          }

          isUpdating = false;
        }

        function reset() {
          ["jpyKrw", "twdKrw", "jpyCost", "krwNeed", "convertKrw", "convertTwd"].forEach((id) => {
            document.getElementById(id).value = "";
          });
          document.getElementById("jpyCost").value = "0.21";
          document.getElementById("summary").textContent = "è«‹è¼¸å…¥åŒ¯ç‡èˆ‡ï¼ˆå¯é¸ï¼‰æƒ³æ›çš„éŸ“å…ƒé‡‘é¡ï¼Œç„¶å¾ŒæŒ‰ã€Œè¨ˆç®—ã€ã€‚";

          // æ¸…é™¤æœ¬åœ°å„²å­˜
          localStorage.removeItem("exchangeData");
        }

        function init() {
          // è¼‰å…¥æœ¬åœ°å„²å­˜è³‡æ–™
          loadFromLocalStorage();

          // è¨­ç½®åˆå§‹ç‹€æ…‹ç‚ºéŸ“å…ƒåœ¨å‰é¢
          const convertRow = document.getElementById("convertRow");
          convertRow.classList.add("cvt-krw");

          // ç¶å®šäº‹ä»¶
          document.getElementById("calcBtn").addEventListener("click", calc);
          document.getElementById("resetBtn").addEventListener("click", reset);

          // å³æ™‚æ›ç®—äº‹ä»¶ - éŸ“å…ƒè¼¸å…¥æ™‚æ›´æ–°å°å¹£
          $("convertKrw").addEventListener("input", function () {
            updateKrwToTwd();
          });

          // å°å¹£è¼¸å…¥æ™‚æ›´æ–°éŸ“å…ƒ
          $("convertTwd").addEventListener("input", function () {
            updateTwdToKrw();
          });

          // ç•¶åŒ¯ç‡æ”¹è®Šæ™‚ä¹Ÿè¦æ›´æ–°æ›ç®—çµæœ
          $("twdKrw").addEventListener("input", function () {
            const convertKrw = parseFloat($("convertKrw").value) || 0;
            const convertTwd = parseFloat($("convertTwd").value) || 0;

            if (convertKrw > 0 && !$("convertKrw").readOnly) {
              updateKrwToTwd();
            } else if (convertTwd > 0 && !$("convertTwd").readOnly) {
              updateTwdToKrw();
            }
            saveToLocalStorage();
          });

          // è‡ªå‹•å„²å­˜äº‹ä»¶
          ["jpyKrw", "jpyCost", "krwNeed"].forEach((id) => {
            document.getElementById(id).addEventListener("input", saveToLocalStorage);
            document.getElementById(id).addEventListener("change", saveToLocalStorage);
          });

          // å³æ™‚æ›ç®—çš„è¼¸å…¥æ¡†ä¹Ÿè¦å„²å­˜
          $("convertKrw").addEventListener("input", saveToLocalStorage);
          $("convertTwd").addEventListener("input", saveToLocalStorage);

          // å°èª¿æŒ‰éˆ•äº‹ä»¶
          document.getElementById("swapBtn").addEventListener("click", function () {
            const convertRow = document.getElementById("convertRow");

            // åˆ‡æ› CSS class ä¾†æ”¹è®Šé †åº
            if (convertRow.classList.contains("cvt-twd")) {
              // åˆ‡æ›å›éŸ“å…ƒåœ¨å‰é¢
              convertRow.classList.remove("cvt-twd");
              convertRow.classList.add("cvt-krw");

              // éŸ“å…ƒå¯è¼¸å…¥ï¼Œå°å¹£å”¯è®€
              $("convertKrw").removeAttribute("readonly");
              $("convertKrw").placeholder = "è¼¸å…¥éŸ“å…ƒé‡‘é¡";
              $("convertTwd").setAttribute("readonly", "");
              $("convertTwd").placeholder = "çµæœ";
            } else {
              // åˆ‡æ›åˆ°å°å¹£åœ¨å‰é¢
              convertRow.classList.remove("cvt-krw");
              convertRow.classList.add("cvt-twd");

              // å°å¹£å¯è¼¸å…¥ï¼ŒéŸ“å…ƒå”¯è®€
              $("convertTwd").removeAttribute("readonly");
              $("convertTwd").placeholder = "è¼¸å…¥å°å¹£é‡‘é¡";
              $("convertKrw").setAttribute("readonly", "");
              $("convertKrw").placeholder = "çµæœ";
            }

            // å„²å­˜åˆ°æœ¬åœ°
            saveToLocalStorage();
          });
        }
        init();

        function calc() {
          const jpyKrw = parseFloat($("jpyKrw").value); // æ—¥å¹£ â†’ éŸ“å…ƒ åŒ¯ç‡
          const twdKrw = parseFloat($("twdKrw").value); // å°å¹£ â†’ éŸ“å…ƒ åŒ¯ç‡
          const jpyCost = parseFloat($("jpyCost").value); // ä½ çš„æ—¥å¹£æˆæœ¬ï¼ˆå°å¹£/æ—¥åœ“ï¼‰
          // ä½ éœ€è¦çš„éŸ“å…ƒé‡‘é¡ï¼ˆKRWï¼‰ï¼Œä¾†æº input å¯èƒ½æœ‰åƒåˆ†ä½
          const krwNeedRaw = $("krwNeed").value.replace(/,/g, "");
          const krwNeed = parseFloat(krwNeedRaw);

          if (!(jpyKrw > 0 && twdKrw > 0 && jpyCost > 0)) {
            document.getElementById("summary").innerHTML = '<div class="warning">è«‹å…ˆå¡«å¯«ã€Œæ—¥å¹£â†’éŸ“å…ƒã€ã€ã€Œå°å¹£â†’éŸ“å…ƒã€èˆ‡ã€Œä½ çš„æ—¥å¹£æˆæœ¬ã€ã€‚</div>';
            return;
          }

          // é–€æª» JPYâ†’KRW åŒ¯ç‡
          const thresholdJPY = twdKrw * jpyCost;

          // ç”¨å°å¹£æ›éŸ“å…ƒï¼šæ¯ 1000 KRW éœ€è¦çš„ TWD æˆæœ¬
          const twdCostPerBaseKrw = baseKrw / twdKrw;

          // ç”¨æ—¥å¹£æ›éŸ“å…ƒï¼šæ¯ 1000 KRW éœ€è¦çš„ JPY æˆæœ¬
          const jpyCostPerBaseKrw = baseKrw / jpyKrw;

          // ç”¨æ—¥å¹£æ›éŸ“å…ƒï¼šæ¯ 1000 KRW éœ€è¦çš„ TWD æˆæœ¬
          const twdCostPerBaseKrwByJpy = jpyCostPerBaseKrw * jpyCost;

          // æ–°å¢ï¼šæ¯ 1 å°å¹£å¯ä»¥æ›å¤šå°‘éŸ“å…ƒ
          const krwPerTwd = twdKrw; // ç›´æ¥å°±æ˜¯å°å¹£â†’éŸ“å…ƒåŒ¯ç‡
          // æ–°å¢ï¼šç”¨æ—¥å¹£æ›éŸ“å…ƒå†æ›ç®—æˆå°å¹£ï¼Œæ¯ 1 å°å¹£å¯æ›å¤šå°‘éŸ“å…ƒ
          const krwPerTwdByJpy = jpyKrw / jpyCost;

          // åˆ¤æ–·å“ªå€‹åˆ’ç®—
          const better = jpyKrw > thresholdJPY ? "ç”¨æ—¥å¹£æ›" : "ç”¨å°å¹£æ›";
          const betterReason = `ï¼ˆç¾å ´åŒ¯ç‡ ${jpyKrw.toFixed(4)} ${jpyKrw > thresholdJPY ? "<" : ">"} é–€æª»åŒ¯ç‡ ${thresholdJPY.toFixed(4)}ï¼‰`;

          const html = [];
          html.push(`<div class="result-item">é–€æª» JPYâ†’KRW åŒ¯ç‡ï¼š<span class="result-bold">${thresholdJPY.toFixed(4)}</span> KRW</div>`);
          html.push(`<div class="result-item">ç¾å ´ JPYâ†’KRW åŒ¯ç‡ï¼š<span class="result-bold">${jpyKrw.toFixed(4)}</span> KRW</div>`);
          html.push(`<div class="result-item"><span>â¡ ç”¨å°å¹£æ›éŸ“å…ƒï¼š</span>`);
          html.push(`
<div class="result-indent">  
    <div class="result-item">æ¯ ${baseKrw} KRW æˆæœ¬ <span class="result-bold">${twdCostPerBaseKrw.toFixed(4)}</span> TWD</div>
    <div class="result-item">æ¯å°å¹£å¯æ›<span class="result-bold">${krwPerTwd.toFixed(2)}</span> éŸ“å…ƒ</div>
</div>`);

          html.push(`<div class="result-item"><span>â¡ ç”¨æ—¥å¹£æ›éŸ“å…ƒï¼š</span>`);
          html.push(`
<div class="result-indent">  
    <div class="result-item">æ¯ ${baseKrw} KRW æˆæœ¬ <span class="result-bold">${twdCostPerBaseKrwByJpy.toFixed(4)}</span> TWD (<span class="result-bold">${jpyCostPerBaseKrw.toFixed(4)}</span> JPY)</div>
    <div class="result-item">æ¯å°å¹£å¯æ›<span class="result-bold">${krwPerTwdByJpy.toFixed(2)}</span> éŸ“å…ƒï¼ˆå…ˆæ›æˆæ—¥å¹£æˆæœ¬ï¼Œå†æ›æˆå°å¹£ï¼‰</div>
</div>`);
          html.push(`<div class="result-conclusion">çµè«–ï¼š<span class="result-bold">${better}</span> æ¯”è¼ƒåˆ’ç®— ${betterReason}</div>`);

          if (krwNeed) {
            html.push(`<div class="result-amount">æ›éŸ“å…ƒï¼š<span class="result-bold">${krwNeed.toLocaleString()}</span> KRW</div>`);
            html.push(`<div class="result-item">å°å¹£ï¼š<span class="result-bold">${((krwNeed / baseKrw) * twdCostPerBaseKrw).toLocaleString()}</span> TWD</div>`);
            html.push(`<div class="result-item">æ—¥å¹£ï¼š<span class="result-bold">${((krwNeed / baseKrw) * jpyCostPerBaseKrw).toLocaleString()}</span> JPY</div>`);
            html.push(`</div>`);
          }

          document.getElementById("summary").innerHTML = html.join("");
        }
      })();
    </script>
  </body>
</html>
